# Metrics Definitions

This document defines the exact formulas used in `scripts/compute_metrics.py` for all KPI calculations.

---

## 1. Activation Rate
The percentage of users who reach the "Aha! Moment" within a specific window.

- **Formula**: `Count(Users with "activate" event within 14 days of signup) / Count(Total Signups)`
- **Implementation**: Activation window is 14 days from signup_date
- **Business Logic**: Measures the effectiveness of the onboarding flow

---

## 2. Monthly Recurring Revenue (MRR)
The predictable total revenue generated by all active subscriptions.

- **Formula**: `Sum(monthly_price of all Active Subscriptions)`
- **Normalization**: 
  - Monthly plans: `monthly_price = price`
  - Annual plans: `monthly_price = price / 12`
- **Filter**: Only subscriptions with `status = "active"`

---

## 3. Annual Recurring Revenue (ARR)
The annualized value of all recurring revenue.

- **Formula**: `ARR = MRR × 12`

---

## 4. Average Revenue Per User (ARPU)
The average revenue contribution of each active user.

- **Formula**: `ARPU = Total MRR / max(1, Active Users)`
- **Guard**: Division by zero protection using max(1, active_users)

---

## 5. MRR-Based Churn Rate (Monthly)
The rate at which MRR is lost due to cancellations.

**Analysis Period**: Last complete month (e.g., if today is Dec 12, analyze November)

- **MRR Start**: Sum of monthly_price for subscriptions active at beginning of analysis month
  - Filter: `start_date < month_start AND (end_date IS NULL OR end_date >= month_start)`
  
- **MRR Churn**: Sum of monthly_price for subscriptions that ended during analysis month
  - Filter: `end_date >= month_start AND end_date <= month_end`
  
- **MRR Expansion**: Sum of monthly_price for new subscriptions started during analysis month
  - Filter: `start_date >= month_start AND start_date <= month_end`

- **Churn Rate Formula**: `churn_rate = MRR Churn / max(1e-6, MRR Start)`
- **Guard**: If MRR Start < 1e-6, churn_rate = 0.0

---

## 6. Net Revenue Retention (NRR)
Measures revenue retention including expansion from existing customers.

- **Formula**: `NRR = (MRR Start + MRR Expansion - MRR Churn) / MRR Start`
- **Guard**: If MRR Start < 1e-6, NRR = null
- **Interpretation**: 
  - NRR > 1.0: Expansion exceeds churn (ideal for SaaS)
  - NRR = 1.0: Expansion exactly offsets churn
  - NRR < 1.0: Losing revenue from existing base

---

## 7. Gross Revenue Retention (GRR)
Measures revenue retention excluding expansion (pure retention).

- **Formula**: `GRR = (MRR Start - MRR Churn) / MRR Start`
- **Guard**: If MRR Start < 1e-6, GRR = null
- **Range**: 0.0 to 1.0 (100% means zero churn)

---

## 8. Quick Ratio
Measures growth efficiency by comparing new/expansion MRR to churned MRR.

- **Formula**: `Quick Ratio = MRR Expansion / MRR Churn`
- **Guard**: 
  - If MRR Churn < 1e-6 and MRR Expansion = 0: null
  - If MRR Churn < 1e-6 and MRR Expansion > 0: infinity (not reported)
- **Interpretation**: Higher is better; >1.0 means growth outpaces churn

---

## 9. Customer Lifetime Value (LTV)
The total expected revenue from a single customer over their entire relationship.

- **Customer Lifetime (Months)**: `1 / churn_rate` (if churn_rate > 1e-6, else null)
- **LTV Formula**: `avg_ltv = ARPU / churn_rate` (if churn_rate > 1e-6, else null)
- **Guard**: If churn is zero or negligible, LTV is undefined (null)
- **Interpretation**: If churn_rate = 0.05 (5%), average customer stays 20 months

---

## 10. Customer Acquisition Cost (CAC)
Average cost to acquire one new customer.

- **Data Source**: `data/marketing_costs.csv` (optional file)
- **Formula**: `CAC = Total Marketing Costs in Month / New Customers Acquired in Month`
- **Analysis Period**: Last complete month
- **Guard**: 
  - If marketing_costs.csv does not exist: CAC = null
  - If new_customers_last_month = 0: CAC = null
- **Note**: CAC is null by default unless marketing_costs.csv is provided

---

## 11. Payback Period (Months)
Time required to recover customer acquisition cost.

- **Formula**: `Payback Period = CAC / ARPU` (if CAC available and ARPU > 1e-6, else null)
- **Guard**: Only calculated when CAC is not null and ARPU > 0
- **Interpretation**: If CAC = $500 and ARPU = $100, payback = 5 months

---

## 12. Cohort Retention
Percentage of original users from a specific signup month who remain active over subsequent months.

- **Cohort Definition**: Users grouped by signup_month
- **Activity Definition**: Any event in a given month
- **Formula**: `Retention % = (Users from Cohort C active in Month M) / (Total Users in Cohort C)`
- **Output**: Pivot table with signup_month as rows, months_since as columns

---

## 13. Funnel Conversion
Measures user progression through key stages.

- **Stages**: Signup → Activation → Paid
- **Activation Conversion**: `activation_count / signup_count`
- **Paid Conversion**: `paid_count / signup_count`
- **Output**: funnel_summary.csv with stage, count, and conversion_rate

---

## Implementation Notes

### Division by Zero Guards
All division operations use guards to prevent errors:
- User counts: `max(1, count)`
- MRR values: `max(1e-6, mrr_value)` with threshold checks
- Null values returned when denominators are too small

### Date Handling
- **Analysis Period**: Last complete calendar month
- **Month Boundaries**: First day of month to last day of month
- **Activation Window**: 14 days from signup_date

### Revenue Type Semantics
The `revenue.csv` file includes a `revenue_type` column with values:
- `recurring`: Regular subscription payments
- `expansion`: Upgrades or add-ons
- `one_time`: Non-recurring charges

### Subscription Status
- `active`: Currently paying subscription
- `cancelled`: Ended subscription (has end_date)
- Subscriptions without end_date are considered ongoing

